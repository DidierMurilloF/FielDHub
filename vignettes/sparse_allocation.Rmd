---
title: "Sparse Allocation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sparse Allocation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA,
  warning = FALSE, 
  message = FALSE
)
```


## Sparse Allocation/Testing

This vignette shows how to generate **sparse allocation experiments** using both the FielDHub Shiny App and the scripting function `sparse_allocation()` from the `FielDHub` R package.

## Overview

A sparse allocation experiment is useful for its increased efficiency, as breeders can use a large number of treatments over multiple locations in a single experiment. A sparse allocation experiment can also increase use fewer experimental units than other designs, which makes them cost-effective as well. 

FielDHub includes a function to run such experimental designs, as well as an interface for creating a sparse allocation design on the FielDHub app. 

## Use Case

A plant breeding field trial has 260 entries, tested over 5 locations, and with 4 checks. Each entry will be replicated 4 times, using the sparse allocation method. 

## Running the Shiny App

To launch the app you need to run either

```{r, eval=FALSE}
FielDHub::run_app()
```

or

```{r, eval=FALSE}
library(FielDHub)
run_app()
```

## 1. Using the FielDHub Shiny App

Once the app is running, go to **Unreplicated Designs** > **Sparse Allocation**

Then, follow the following steps where we will show how to generate a sparse allocation experiment.

##  Inputs 

1. **Import entries' list?** Choose whether to import a list with entry numbers and names for genotypes or treatments.
    * If the selection is `No`, that means the app is going to generate synthetic data for entries and names of the treatment/genotypes based on the user inputs.

    * If the selection is `Yes`, the entries list must fulfill a specific format and must be a `.csv` file. The file must have the columns `ENTRY` and `NAME`. The `ENTRY` column must have a unique integer number entry for each treatment/genotype. The column `NAME` must have a unique name that identifies each treatment/genotype. Both `ENTRY` and `NAME` must be unique, duplicates are not allowed. In the following table, we show an example of the entries list format. Any checks must appear in the first rows of the `.csv` file. 

```{r, include=FALSE}
ENTRY <- 1:9
NAME <- c(c("CHECK1","CHECK2","CHECK3"), c(paste0("Genotype", LETTERS[1:6])))
df <- data.frame(ENTRY,NAME)
```

```{r, echo = FALSE, results='asis'}
library(knitr)
kable(df)
```

2. Enter the number of entries/treatments in the **Input # of Entries** box, which is 260 in our case.

3. Select 4 from the drop-down on the **Input # of Checks** box. 

4. Since we want to run this experiment over 5 locations, set **Input # of Locations** to 5.

5. Set the number of copies of each treatment in the **# of Copies Per Entry** dropdown box to 4. 

6. Select `serpentine` or `cartesian` in the **Plot Order Layout**. For this example we will use the `serpentine` layout.

7. To ensure that randomizations are consistent across sessions, we can set a seed number in the box labeled **Random Seed**. For instance, we will set it to `16`. 

8. Enter the name for the experiment in the **Input Experiment Name** box. For example, `PYT_BARLEY_2023`.

9. Enter the starting plot number in the **Starting Plot Number** box. In this experiment we want the plot start at `1001`.

10. Enter the name of the site/location in the **Input the Location** box. For this experiment we will set the site as `FARGO`. In the case of users will run the experiment in multiple locations, the name for each location must be enter separate by comma, for example: `FARGO, CASSELTON, MINOT`.

11. Once we have entered all the information for our experiment on the left side panel, click the **Run!** button to run the design. 

12. You will then be prompted to select the dimensions of the field from the list of options in the drop-down in the middle of the screen with the box labeled **Select dimensions of field**. In our case, we will select `16 x 15`. 

13. Click the **Randomize!** button to randomize the experiment with the set field dimensions and to see the output plots. 

If you change any of the inputs on the left side panel after running an experiment initially, you have to click the Run and Randomize buttons again, to re-run with the new inputs.

## Outputs

After you run a sparse allocation design in FielDHub and set the dimensions of the field, there are several ways to display the information contained in the field book. 

### Expt Design Info

On the first tab, **Expt Design Info**, you can see all the entries in the randomization displayed in a binary matrix with a column for each location, with a 1 indicating that the respective genotype is in the respective location, and a 0 indicating that it is not. This is the sparse genotype allocation characteristic of this method. There are buttons to copy, print, and save the table to an Excel file. 

### Randomized Field

The **Randomized Field** tab displays a graphical representation of the randomization of the entries in a field of the specified dimensions. The checks are each colored uniquely, showing the number of times they are distributed throughout the field. The display includes numbered labels for the rows and columns. You can copy the field as a table or save it directly as an Excel file with the _Copy_ and _Excel_ buttons at the top. 

In the **Choose % of Checks:** drop-down box, users can play with different options for the total amount of checks in the field. 

### Plot Number Field

On the **Plot Number Field** tab, there is a table display of the field with the plots numbered according to the Plot Order Layout specified, either _serpentine_ or _cartesian_. You can see the corresponding entries for each plot number in the field book. Like the Randomized Field tab, you can copy the table or save it as an Excel file with the _Copy_ and _Excel_ buttons. 

### Field Book

The **Field Book** displays all the information on the experimental design in a table format. It contains the specific plot number and the row and column address of each entry, as well as the corresponding treatment on that plot. This table is searchable, and we can filter the data in relevant columns. 

<br>

## 2. Using the `FielDHub` function: `sparse_allocation()`

You can run the same design with a function in the FielDHub package, `sparse_allocation()`.

First, you need to load the `FielDHub` package typing,

```{r, echo = TRUE}
library(FielDHub)
```

Then, you can enter the information describing the above design like this:

```{r, echo = TRUE, warning=FALSE, comment=''}
sparse <- sparse_allocation(
   lines = 260, 
   l = 5, 
   plant_reps = 4, 
   checks = 4, 
   locationNames = c("LOC1", "LOC2", "LOC3", "LOC4", "LOC5"), 
   seed = 1234
)
```

#### Details on the inputs entered in `sparse_allocation()` above:

*   `lines = 260` is the number of genotypes.
*   `l = 5` is the number of locations.
*   `plant_reps = 4` is the number of copies of each entry.
*   `checks = 4` is the number of checks.\
*   `locationNames = c("LOC1", "LOC2", "LOC3", "LOC4", "LOC5")` optional name for each location.
*   `seed = 1234` is the random seed number to replicate identical randomizations.

### Print `sparse` object

To print a summary of the information that is in the object `sparse`, we can use the generic function `print()`. The `sparse_allocation()` function returns a list of 4 objects, `designs`, `list_locs`, `allocation`, and `size_locations`. `designs` contains information about the design parameters, `list_locs` is a list of entries in a location, `allocation` is the binary allocation matrix for a location, and `size_locations` is a data frame with a column for each location and a row indicating the size of the location. The first 3 of these in the list are indexable by location.

For example, we can save the design parameters to an object `designs`, and then index based on location using the dollar sign operator. We can first display the design parameters for LOC1 with the following code:

```{r, echo=TRUE, eval=FALSE}
designs <- sparse$designs
print(designs$LOC1)
```

which outputs:

```{r, echo=FALSE, eval=TRUE}
designs <- sparse$designs
print(designs$LOC1)
```

And for LOC2 by changing the location to print to LOC2:

```{r, echo=TRUE, eval=FALSE}
print(designs$LOC2)
```

which outputs:

```{r, echo=FALSE, eval=TRUE}
print(designs$LOC2)
```

### Access to `sparse` object

The object `designs` we saved `sparse$designs` to is a list consisting of all the information displayed in the output tabs in the FielDHub app: design information, plot layout, plot numbering, entries list, and field book, indexed by each location in the experiment. These are accessible by the `$` operator, i.e. `designs$LOC1$layoutRandom` or `designs$LOC1$fieldBook` for LOC1, etc. 

`designs$LOC1$fieldBook` is a data frame containing information about every plot in the field, with information about the location of the plot and the treatment in each plot. As seen in the output below, the field book has columns for `ID`, `EXPT`, `LOCATION`, `YEAR`, `PLOT`, `ROW`, `COLUMN`, `CHECKS`, `ENTRY`, and `TREATMENT`.

Let us see the first 10 rows of the field book for the first location in this experiment.

```{r, echo=TRUE, eval=FALSE}
field_book <- designs$LOC1$fieldBook
head(field_book, 10)
```

```{r, echo=FALSE, eval=TRUE}
field_book <- designs$LOC1$fieldBook
head(field_book, 10)
```

### Plot field layout

For plotting the layout in function of the coordinates `ROW` and `COLUMN` in the field book object we can use the generic function `plot()` as follows,

```{r, fig.align='center', fig.width=7.2, fig.height=5}
plot(designs$LOC1)
```

The above plot is for LOC1. We can plot any location in the experiment, like location 2 in this example:

```{r, fig.align='center', fig.width=7.2, fig.height=5}
plot(designs$LOC2)
```

The figure above shows a map of an experiment randomized as an unreplicated arrangement design. Gray plots represent the unreplicated treatments, while the yellow-boxed colored check plots are replicated throughout the field in a systematic diagonal arrangement. The red plots with 0s are are fillers. 

<br>
<br>
<br>